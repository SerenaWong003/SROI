import streamlit as st
import pandas as pd
from fpdf import FPDF
import base64

# --- [‡∏Ñ‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô Logic ‡πÅ‡∏•‡∏∞ UI ‡πÑ‡∏ß‡πâ] ---

def create_pdf(ratio, total_pv, total_input, details):
    pdf = FPDF()
    pdf.add_page()
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏° Font (‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÉ‡∏ô PDF ‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå .ttf ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ ‡πÅ‡∏ï‡πà‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏à‡∏±‡πà‡∏ô‡πÄ‡∏à‡∏≤‡∏Ç‡∏≠‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô Standard Eng ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö)
    pdf.set_font("Arial", 'B', 16)
    pdf.cell(200, 10, txt="SROI Analysis Report", ln=True, align='C')
    
    pdf.set_font("Arial", size=12)
    pdf.ln(10)
    pdf.cell(200, 10, txt=f"Project: {st.session_state.get('project_name', 'Research Project')}", ln=True)
    pdf.cell(200, 10, txt=f"SROI Ratio: {ratio:.2f}", ln=True)
    pdf.cell(200, 10, txt=f"Total Present Value: {total_pv:,.2f} THB", ln=True)
    pdf.cell(200, 10, txt=f"Total Investment: {total_input:,.2f} THB", ln=True)
    
    pdf.ln(10)
    pdf.set_font("Arial", 'B', 12)
    pdf.cell(200, 10, txt="Stakeholder Details:", ln=True)
    
    pdf.set_font("Arial", size=10)
    for idx, item in enumerate(details):
        text = f"{idx+1}. {item['stakeholder']}: PV = {item['item_pv']:,.2f} THB"
        pdf.cell(200, 7, txt=text, ln=True)
        
    return pdf.output(dest='S').encode('latin-1')

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡πâ‡∏î (‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡∏£‡πá‡∏à) ---
# [‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Metric ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö]

if 'calculated' in st.session_state and st.session_state.calculated:
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF
    pdf_bytes = create_pdf(st.session_state.ratio, st.session_state.total_pv, total_input, st.session_state.details)
    
    st.download_button(
        label="üì• Download SROI Report (PDF)",
        data=pdf_bytes,
        file_name="SROI_Report.pdf",
        mime="application/pdf",
        use_container_width=True
    )
